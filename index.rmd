---
title: "COVID-19 Prediciton on Confirmed Case in Taiwan"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    source_code: https://github.com/dspim/COVID-19-Forecasts
---
  
```{r setup, include=FALSE}
library(plotly)
library(tidyr)
library(dplyr)
library(dygraphs)
library(flexdashboard)

dat1_global <- read.csv("data/Stage1/Stage1_NovelCovid_worldwide.csv", stringsAsFactors = FALSE) 
dat1_tw <- read.csv("data/Stage1/Stage1_NovelCovid_tw.csv", stringsAsFactors = FALSE) 
dat1_tw_c <- read.csv("data/Stage1/Stage1_Taiwan_CDC.csv", stringsAsFactors = FALSE)

dat2_global <- read.csv("data/Stage2/Stage2_worldwide_pred.csv", stringsAsFactors = FALSE) 
dat2_tw <- read.csv("data/Stage2/Stage2_tw_pred.csv", stringsAsFactors = FALSE) 
dat2_tw_c <- read.csv("data/Stage2/Stage2_tw_county_pred.csv", stringsAsFactors = FALSE) 
r <- read.csv("data/country_region.csv", stringsAsFactors = FALSE) %>% 
  rename("country" = "name") %>% 
  select(country, region, sub.region)
r$country <- r$country %>% tolower()

now <- Sys.Date()-1
```

Nationwide
=====================================  

Column {data-width=600}
-----------------------------------------------------------------

### Total Confirmed Cases (Taiwan)

```{r}
cbind(
  actual = ts(dat1_tw$actual_cases,
              start = as.Date("2020-02-01"),
              frequency = 1),
  pred = ts(c(rep(NA, nrow(dat1_tw)-1), 
              dat1_tw$actual_cases[dat1_tw$date == now], # 當天資料用真實值
              dat2_tw[dat2_tw$date == now, c(5:11)] %>% unlist() %>% unname()), 
            # 從predict_cases 開始畫
            start = as.Date("2020-02-01"),
            frequency = 1)
) %>%
  dygraph(ylab = "Cases") %>% 
  dyOptions(colors = c("#66C2A5", "#FC8D62", "#8DA0CB"),
              #RColorBrewer::brewer.pal(3, "Set2")
             strokeWidth = 5)
```

### Daily New Confirmed Cases (World)

```{r}
dat_world <- dat1_global %>% 
  left_join(r) %>% 
  na.omit() %>% 
  select(date, sub.region, actual_cases) %>% 
  group_by(date, sub.region) %>% 
  summarise(actual_cases = sum(actual_cases)) %>% 
  spread(sub.region, actual_cases) 

data.frame(
  date = as.Date(dat_world$date[2:nrow(dat_world)]),
  v1 = sapply(2:nrow(dat_world), function(i){dat_world$`Australia and New Zealand`[i] - dat_world$`Australia and New Zealand`[i-1]}),
  v2 = sapply(2:nrow(dat_world), function(i){dat_world$`Eastern Asia`[i] - dat_world$`Eastern Asia`[i-1]}),
  v3 = sapply(2:nrow(dat_world), function(i){dat_world$`Northern America`[i] - dat_world$`Northern America`[i-1]}),
  v4 = sapply(2:nrow(dat_world), function(i){dat_world$`Northern Europe`[i] - dat_world$`Northern Europe`[i-1]}),
  v5 = sapply(2:nrow(dat_world), function(i){dat_world$`Western Europe`[i] - dat_world$`Western Europe`[i-1]})
) %>% 
  plot_ly(x = ~date, y = ~v1,
          name = 'Australia and New Zealand',
          type = 'bar', 
          marker = list(color = '#E78AC3')#,
          # text = ~n, 
          # hovertemplate = paste('%{x}', '<br>人數: %{text:.s}<br>'),
          # texttemplate = '%{y:.2s}',
          # textposition = 'outside', 
          # width = 0.2
  ) %>% 
  add_trace(y = ~v2, name = 'Eastern Asia', marker = list(color = '#66C2A5')) %>% 
  add_trace(y = ~v3, name = 'Northern America', marker = list(color = '#FC8D62')) %>% 
  add_trace(y = ~v4, name = 'Northern Europe', marker = list(color = '#8DA0CB')) %>% 
  add_trace(y = ~v5, name = 'Western Europe', marker = list(color = '#A6D854')) %>% 
  layout(uniformtext=list(minsize = Inf, mode='hide'),
         xaxis = list(showline = F,
                      fixedrange = T, 
                      title = "Date"),
         yaxis = list(fixedrange = T, 
                      title = "Cases"),
         # autosize = F,
         legend = list(x = 0.4, y = 0.9))
```


Column {data-width=400}
-----------------------------------------------------------------

### Prediction Errors

```{r}
true <- dat1_tw$actual_cases[dat1_tw$date == now]
pred <- dat2_tw$predict_cases[dat2_tw$date == (now-1)]
valueBox(round(true - pred), icon = "fa-frown-open")
```

### Growth Rate of Daily new confirmed cases (Taiwan)

```{r}
true <- dat1_tw$actual_cases[dat1_tw$date == now]
pred <- dat2_tw$predict_cases[dat2_tw$date == (now-1)]
v <- (true - pred)/true
valueBox(paste0(round(100*v, digits = 2), "%"), 
         icon = "fa-chart-line")
```


### Daily new confirmed cases (Taiwan)

```{r}
d_tw <- data.frame(
  date = as.Date(dat1_tw$date[2:nrow(dat1_tw)]),
  n = sapply(2:nrow(dat1_tw), function(i){
      dat1_tw$actual_cases[i] - dat1_tw$actual_cases[i-1]
    }) 
  ) 
d_tw %>% 
  plot_ly(x = ~date, y = ~n,
          type = 'bar', 
          marker = list(color = 'rgb(49,130,189)'),
          text = ~n, 
          hovertemplate = paste('%{x}', '<br>Cases: %{text:.s}<br>'),
          texttemplate = '%{y:.2s}',
          textposition = 'outside'
          ) %>% 
  layout(uniformtext=list(minsize = max(d_tw$n), mode='hide'),
    xaxis = list(showline = F,
                      fixedrange = T, 
                      title = "Date"),
         yaxis = list(fixedrange = T, 
                      title = "Cases")) 
```

Selected Regions {data-orientation=rows}
=====================================  

Row
-------------------------------------
    
### Total Confirmed Cases (Taipei)
    
```{r}
# Taipei
d1 <- dat1_tw_c %>% 
  filter(county == "台北市")
d2 <- dat2_tw_c %>% 
  filter(county == "台北市")
cbind(
  actual = ts(d1$actual_cases,
              start = as.Date("2020-02-01"),
              frequency = 1),
  pred = ts(c(rep(NA, nrow(d1)-1), 
              d1$actual_cases[d1$date == now],
              d2[d2$date == (now), c(4:10)] %>% unlist() %>% unname()),
            start = as.Date("2020-02-01"),
            frequency = 1)
) %>%
  dygraph(ylab = "Cases") %>% 
  dyOptions(colors = c("#66C2A5", "#FC8D62", "#8DA0CB"),
            #RColorBrewer::brewer.pal(3, "Set2")
            strokeWidth = 5)  
```
 
### Total Confirmed Cases (New Taipei City)
    
```{r}
# New Taipei City
d1 <- dat1_tw_c %>% 
  filter(county == "新北市")
d2 <- dat2_tw_c %>% 
  filter(county == "新北市")
cbind(
  actual = ts(d1$actual_cases,
              start = as.Date("2020-02-01"),
              frequency = 1),
  pred = ts(c(rep(NA, nrow(d1)-1), 
              d1$actual_cases[d1$date == now],
              d2[d2$date == (now), c(4:10)] %>% unlist() %>% unname()),
            start = as.Date("2020-02-01"),
            frequency = 1)
) %>%
  dygraph(ylab = "Cases") %>% 
  dyOptions(colors = c("#66C2A5", "#FC8D62", "#8DA0CB"),
            #RColorBrewer::brewer.pal(3, "Set2")
            strokeWidth = 5)  
``` 

Row
-------------------------------------
    
### Total Confirmed Cases (Taoyuan)
    
```{r}
# Taoyuan
d1 <- dat1_tw_c %>% 
  filter(county == "桃園市")
d2 <- dat2_tw_c %>% 
  filter(county == "桃園市")
cbind(
  actual = ts(d1$actual_cases,
              start = as.Date("2020-02-01"),
              frequency = 1),
  pred = ts(c(rep(NA, nrow(d1)-1), 
              d1$actual_cases[d1$date == now],
              d2[d2$date == (now), c(4:10)] %>% unlist() %>% unname()),
            start = as.Date("2020-02-01"),
            frequency = 1)
) %>%
  dygraph(ylab = "Cases") %>% 
  dyOptions(colors = c("#66C2A5", "#FC8D62", "#8DA0CB"),
            #RColorBrewer::brewer.pal(3, "Set2")
            strokeWidth = 5)  
```
    
### Total Confirmed Cases (Taichung)

```{r}
# Taichung
d1 <- dat1_tw_c %>% 
  filter(county == "台中市")
d2 <- dat2_tw_c %>% 
  filter(county == "台中市")
cbind(
  actual = ts(d1$actual_cases,
              start = as.Date("2020-02-01"),
              frequency = 1),
  pred = ts(c(rep(NA, nrow(d1)-1), 
              d1$actual_cases[d1$date == now],
              d2[d2$date == (now), c(4:10)] %>% unlist() %>% unname()),
            start = as.Date("2020-02-01"),
            frequency = 1)
) %>%
  dygraph(ylab = "Cases") %>% 
  dyOptions(colors = c("#66C2A5", "#FC8D62", "#8DA0CB"),
            #RColorBrewer::brewer.pal(3, "Set2")
            strokeWidth = 5)  
```

